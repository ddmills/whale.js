!function(){var t=this,n=t.whale,i=function(t){return t instanceof i?i:this instanceof i?void(this._Wrapped=t):new i(t)};t.whale=i,i.VERSION="0.0.1",i.noConflict=function(){return t.whale=n,this};var r,s=i.isFunction=function(t){return"function"==typeof t},o=i.clone=function(t){var e,n;if(null===t||"object"!=typeof t)return t;e=t.constructor();for(n in t)e[n]=o(t[n]);return e},a=i.Class=function(){};a.prototype.initialize=function(){this._id=h()},a.extend=function(t){function e(){r||(this.initialize&&this.initialize.apply(this,arguments),this.construct&&this.construct.apply(this,arguments))}var n,i,o;n=this.prototype,r=!0,i=new this,r=!1;for(o in t)i[o]="initialize"!=o&&s(t[o])&&s(n[o])&&s(t[o])?function(t,e){return function(){var i,r;return i=this._super,this._super=n[t],r=e.apply(this,arguments),this._super=i,r}}(o,t[o]):t[o],"initialize"==o&&(i[o]=function(){n.initialize.apply(this),t.initialize.apply(this)});return e.prototype=i,e.prototype.constructor=e,e.extend=arguments.callee,e};var u=0,h=i.genId=function(t){var e=++u+"";return t?t+e:e},c=i.registered={},l=i.get=function(t){if(!c[t])throw'whale inject cannot resolve given dependency "'+t+'"... could not find it in list registered dependencies';return c[t]},f=(i.make=function(t){var e,n,i,r;return n=l(t),e=Array.prototype.slice.call(arguments,1),s(n)?(i=function(){},i.prototype=n.prototype,r=new i,ret=n.apply(r,e),Object(ret)===ret?ret:r):n},i.register=function(t,e){return c[t]=e,c[t]}),p=i.inject=function(t,e){var n,r;for(n=[],r=0;r<t.length;r++)n.push(i.get(t[r]));return e.extend({construct:function(){this._super&&this._super.apply(this,n.concat(Array.prototype.slice.call(arguments,0)))}})},d=(i.Factory=function(t,e,n,r){"string"==typeof r&&(r=i.get(r)),r=r||a;var s=p(e,r.extend(n));return null!=t?f(t,s):s},i.Service=function(t,e,n,r){"string"==typeof r&&(r=i.get(r)),r=r||a;var s=new(p(e,r.extend(n)));return null!=t?f(t,s):s},{initialize:function(){this._events=[]},_dispatch:function(t,e){var n=this._events[t];if(!n)return this;for(var i=0;i<n.length;i++){var r=n[i];s(r.action)?r.action.apply(r.ctx,e):r.ctx[r.action].apply(r.ctx,e)}return this},trigger:function(t){var e=Array.prototype.slice.call(arguments,1);return e.unshift(this),this._dispatch(t,e)},when:function(t,e,n){var i=this._events[t]||(this._events[t]=[]);return n=n||this,i.push({action:e,ctx:n}),this},stop:function(t,e,n){var i;if(!t&&!e&&!n)return this._events=[],this;for(evntKeys=t?[t]:Object.keys(this._events),i=0;i<evntKeys.length;i++){var r,s,o,a;if(t=evntKeys[i],r=this._events[t])if(e||n){for(s=[],a=0;a<r.length;a++)o=r[a],(e&&e!==o.action&&e!==o.action._action||n&&n!==o.ctx)&&s.push(o);s.length?this._events[t]=s:delete this._events[t]}else delete this._events[t]}return this}}),g=i.Dispatcher=a.extend(d);i.register("whale.Dispatcher",i.Dispatcher);var v={initialize:function(){this._listening={}},listen:function(t,e,n,i){i=i||this;var r=t._id;return this._listening[r]=t,t.when(e,n,i),this},listenOnce:function(t,e,n,i){i=i||this;var r=function(){this.stopListening(t,e,r),n.apply(this,arguments)};return r._action=n,this.listen(t,e,r,i)},stopListening:function(t,e,n,i){var r,s;if(i=i||this,!t&&!e&&!n){for(var r in this._listening)s=this._listening[r],s.stop(e,n,i),Object.keys(this._listening[r]).length||delete this._listening[r];return this}if(!(t instanceof g))throw"First argument was not a valid Dispatcher object";return r=t._id,s=this._listening[r],s.stop(e,n,i),Object.keys(this._listening[r]).length||delete this._listening[r],this}},y=i.Listener=a.extend(v);i.register("whale.Listener",i.Dispatcher);i.Events=i.Dispatcher.extend(v);i.register("whale.Events",i.Events);var _=i.Dispatcher.extend({idAttribute:"id",attrs:{},urlRoot:"",construct:function(t){t&&this.set(t)},url:function(){var t=this.collection?this.urlRoot||this.collection.urlRoot:this.urlRoot;if(!t)throw"Model does not have a urlRoot or is part of a collection with a urlRoot.";return this.isNew()?t:t.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},toJSON:function(){return i.clone(this.attrs)},isNew:function(){return!this.has(this.idAttribute)},get:function(t){return this.attrs[t]},has:function(t){return null!=this.get(t)},fetch:function(){var t=this;this.trigger("request"),this.trigger("fetch");var e=i.Ajax.get({url:this.url(),parse:!0});return e.done(function(e){t.set(t.parse(e)),t.trigger("fetched"),t.trigger("sync")}),e},save:function(t,e){var n,r,s=this;this.trigger("request"),this.trigger("save"),"object"==typeof t?n=t:(n={})[t]=e,null==t&&(n=this.attrs),r=this.isNew()?"POST":"PUT";var o=i.Ajax.request({method:r,data:n,url:this.url(),parse:!0});return o.done(function(t){t=s.parse(t),t&&(this.set(t),s.trigger("saved"),s.trigger("sync"))}),o},parse:function(t){return t},set:function(t,e){var n,i={};if(null==t)return this;"object"==typeof t?i=t:(i={})[t]=e,this.idAttribute in i&&(this.id=i[this.idAttribute]);for(n in i)i.hasOwnProperty(n)&&(this.attrs[n]=i[n]);return this},unset:function(t){return delete this.attrs[t],this}});i.Model=function(t,e,n){n=n||{};var i=p(e,_.extend(n));return null!=t?f(t,i):i};var m=i.Dispatcher.extend({length:0,models:{},_byId:{},model:_,construct:function(t,e){e&&this.set(e)},reset:function(){this.length=0,this.models={},this._byId={}},parse:function(t){return t},set:function(t){return t=Array.isArray(t)?t:[t],console.log(t),this}});i.Collection=function(t,e,n){n=n||{};var i=p(e,m.extend(n));return null!=t?f(t,i):i},i.View=function(t,e,n){n=n||{};var i=p(e,g.extend(n));return null!=t?f(t,i):i},i.Controller=function(t,e,n){n=n||{};var i=p(e,y.extend(n));return null!=t?f(t,i):i},i.Promise=i.register("whale.Promise",i.Class.extend({initialize:function(){this._response=null,this._onDone=[],this._onFail=[],this._onAlways=[],this.pending=!0,this.fulfilled=!1,this.rejected=!1,this.settled=!1},construct:function(t){this._ctx=t||this},resolve:function(){if(this.pending){this._response=arguments,this.fulfilled=!0,this.settled=!0,this.pending=!1;for(var t=0;t<this._onDone.length;t++)this._onDone[t][0].apply(this._onDone[t][1],arguments);for(var t=0;t<this._onAlways.length;t++){var e=Array.prototype.slice.call(arguments);e.unshift(!0),this._onAlways[t][0].apply(this._onAlways[t][1],e)}}return this},reject:function(){if(this.pending){this._response=arguments,this.rejected=!0,this.settled=!0,this.pending=!1;for(var t=0;t<this._onFail.length;t++)this._onFail[t][0].apply(this._onFail[t][1],arguments);for(var t=0;t<this._onAlways.length;t++){var e=Array.prototype.slice.call(arguments);e.unshift(!1),this._onAlways[t][0].apply(this._onAlways[t][1],e)}}return this},done:function(t,e){var n=e||this._ctx;return this._onDone.push([t,n]),this.fulfilled&&t.apply(n,this._response),this},fail:function(t,e){var n=e||this._ctx;return this._onFail.push([t,n]),this.rejected&&t.apply(n,this._response),this},always:function(t,e){var n=e||this._ctx;return this._onAlways.push([t,n]),this.settled&&t.apply(n,this.fulfilled,this._response),this}})),i.Node=i.register("whale.Node",i.Class.extend({splice:Array.prototype.splice,init:function(){this.length=0},construct:function(t){if(t instanceof NodeList||Array.isArray(t))this.elem=t;else if(t&&t.nodeType)this.elem=[t];else if("string"==typeof t){this.elem=[];var e=document.createElement("div");e.innerHTML=t;for(var n=e.childNodes.length-1;n>=0;n--)this.elem[n]=e.childNodes[n]}else this.elem=[]},on:function(t,e,n){var i=this;return n=n||this,this.each(function(r){r.addEventListener(t,function(){e.call(n,i)})})},off:function(t,e){return this.each(function(n){n.removeEventListener(t,e)})},remove:function(){return this.each(function(t){t.parentNode.removeChild(t)})},addClass:function(t){return this.each(function(e){e.className+=" "+t})},hide:function(){return this.each(function(t){t.style.display="none"})},show:function(){return this.each(function(t){t.style.display="block"})},each:function(t){for(var e=0;e<this.elem.length;e++)t(this.elem[e]);return this},outer:function(){return this.elem[0].outerHTML},html:function(t){return t||""===t?this.each(t instanceof this.constructor?function(e){e.innerHTML="",t.each(function(t){e.appendChild(t)})}:function(e){e.innerHTML=t}):this.elem[0].innerHTML},append:function(t){return t instanceof this.constructor?this.each(function(e){t.each(function(t){e.appendChild(t)})}):e.insertAdjacentHTML("beforeend",t)},prepend:function(t){return t instanceof this.constructor?this.each(function(e){t.each(function(t){e.insertBefore(t,e.firstChild)})}):e.insertAdjacentHTML("afterbegin",t)},before:function(t){return this.each(t instanceof this.constructor?function(e){t.each(function(t){e.parentNode.insertBefore(t,e)})}:function(e){e.insertAdjacentHTML("beforebegin",t)})},after:function(t){var e=this;return this.each(t instanceof e.constructor?function(e){t.each(function(t){e.parentNode.insertBefore(t,e.nextSibling)})}:function(e){e.insertAdjacentHTML("afterend",t)})},find:function(t){var e=[];return this.each(function(n){for(var i=n.querySelectorAll(t),r=i.length-1;r>=0;r--)e[r]=i[r]}),new this.constructor(e)},val:function(t){return t?void this.each(function(){this.value=t}):this.elem[0].value}})),i.Dom=i.Service("whale.Dom",["whale.Node"],{_matches:{"#":"getElementById",".":"getElementsByClassName","@":"getElementsByName","=":"getElementsByTagName"},construct:function(t){this.Node=t},find:function(t){return new i.Node(document.querySelectorAll(t))}}),i.Ajax=i.Service("whale.Ajax",["whale.Promise"],{construct:function(t){this.Prom=t,this.req=!1},_xhr:function(){return new XMLHttpRequest},encode:function(t){if(!t)return"";var e,n;if(e=[],n=function(t,n){n=s(n)?n():null==n?"":n,e[e.length]=encodeURIComponent(t)+"="+encodeURIComponent(n)},Array.isArray(t)||"object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&n(i,t[i]);else n(t);return e.join("&").replace(/%20/g,"+")},request:function(t){var e,n,i,r,s;if("string"==typeof t&&(t={url:t}),!t.url)throw"a url parameter must be specified";if(s=t.url,i=(t.type||t.method||"GET").toUpperCase(),r=this.encode(t.body||t.data||""),parse=t.parse||!1,headers=t.headers||{},content=t.content||"application/x-www-form-urlencoded; charset=UTF-8",e=new this.Prom,n=this._xhr(),n.onreadystatechange=function(){if(4==n.readyState){var t=n.status;if(!t||(200>t||t>=300)&&304!==t)if(parse)try{e.reject(JSON.parse(n.responseText),n)}catch(i){e.reject("Ajax request returned with error status: "+n.status,n)}else e.reject(n.responseText,n);else if(parse)try{e.resolve(JSON.parse(n.responseText),n)}catch(i){e.reject("responseText is not valid JSON",n)}else e.resolve(n.responseText,n)}},n){"GET"==i&&r&&(s+="?"+r,r=null),n.open(i,s),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),"POST"==i&&(n.setRequestHeader("Content-Type",content),n.setRequestHeader("Content-length",r.length),n.setRequestHeader("Connection","close"));for(var o in headers)headers.hasOwnProperty(o)&&n.setRequestHeader(o,headers[o]);n.send(r)}else e.reject("window does not support ActiveXObject or XMLHttpRequest");return e},get:function(t){return this.request(t)},post:function(t){if("string"==typeof t){var e=t;t={type:"POST",url:e}}else t.type="POST";return this.request(t)},put:function(t){if("string"==typeof t){var e=t;t={type:"PUT",url:e}}else t.type="PUT";return this.request(t)},"delete":function(t){if("string"==typeof t){var e=t;t={type:"DELETE",url:e}}else t.type="DELETE";return this.request(t)}})}.call(this);