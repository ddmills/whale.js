!function(){var t=this,e=t.whale,n=function(t){return t instanceof n?n:this instanceof n?void(this._Wrapped=t):new n(t)};t.whale=n,n.VERSION="0.0.1",n.noConflict=function(){return t.whale=e,this};var i,r=n.isFunction=function(t){return"function"==typeof t},s=n.clone=function(t){var e,n;if(null===t||"object"!=typeof t)return t;e=t.constructor();for(n in t)e[n]=s(t[n]);return e},o=n.Class=function(){};o.prototype.initialize=function(){this._id=a()},o.extend=function(t){function e(){i||(this.initialize&&this.initialize.apply(this,arguments),this.construct&&this.construct.apply(this,arguments))}var n,s,o;n=this.prototype,i=!0,s=new this,i=!1;for(o in t)s[o]="initialize"!=o&&r(t[o])&&r(n[o])&&r(t[o])?function(t,e){return function(){var i,r;return i=this._super,this._super=n[t],r=e.apply(this,arguments),this._super=i,r}}(o,t[o]):t[o],"initialize"==o&&(s[o]=function(){n.initialize.apply(this),t.initialize.apply(this)});return e.prototype=s,e.prototype.constructor=e,e.extend=arguments.callee,e};var u=0,a=n.genId=function(t){var e=++u+"";return t?t+e:e},c=n.registered={},h=n.get=function(t){if(!c[t])throw'whale inject cannot resolve given dependency "'+t+'"... could not find it in list registered dependencies';return c[t]},l=(n.make=function(t){var e,n,i,s;return n=h(t),e=Array.prototype.slice.call(arguments,1),r(n)?(i=function(){},i.prototype=n.prototype,s=new i,ret=n.apply(s,e),Object(ret)===ret?ret:s):n},n.register=function(t,e){return c[t]=e,c[t]}),f=n.inject=function(t,e){var i,r;for(i=[],r=0;r<t.length;r++)i.push(n.get(t[r]));return e.extend({construct:function(){this._super&&this._super.apply(this,i.concat(Array.prototype.slice.call(arguments,0)))}})},p=(n.Factory=function(t,e,i,r){"string"==typeof r&&(r=n.get(r)),r=r||o;var s=f(e,r.extend(i));return null!=t?l(t,s):s},n.Service=function(t,e,i,r){"string"==typeof r&&(r=n.get(r)),r=r||o;var s=new(f(e,r.extend(i)));return null!=t?l(t,s):s},{initialize:function(){this._events=[]},_dispatch:function(t,e){var n=this._events[t];if(!n)return this;for(var i=0;i<n.length;i++){var s=n[i];r(s.action)?s.action.apply(s.ctx,e):s.ctx[s.action].apply(s.ctx,e)}return this},trigger:function(t){var e=Array.prototype.slice.call(arguments,1);return e.unshift(this),this._dispatch(t,e)},when:function(t,e,n){var i=this._events[t]||(this._events[t]=[]);return n=n||this,i.push({action:e,ctx:n}),this},stop:function(t,e,n){var i;if(!t&&!e&&!n)return this._events=[],this;for(evntKeys=t?[t]:Object.keys(this._events),i=0;i<evntKeys.length;i++){var r,s,o,u;if(t=evntKeys[i],r=this._events[t])if(e||n){for(s=[],u=0;u<r.length;u++)o=r[u],(e&&e!==o.action&&e!==o.action._action||n&&n!==o.ctx)&&s.push(o);s.length?this._events[t]=s:delete this._events[t]}else delete this._events[t]}return this}}),d=n.Dispatcher=o.extend(p);n.register("whale.Dispatcher",n.Dispatcher);var g={initialize:function(){this._listening={}},listen:function(t,e,n,i){if(i=i||this,"undefined"==typeof t._id)throw"Given object to listen to is not a Dispatcher";var r=t._id;return this._listening[r]=t,t.when(e,n,i),this},listenOnce:function(t,e,n,i){i=i||this;var r=function(){this.stopListening(t,e,r),n.apply(this,arguments)};return r._action=n,this.listen(t,e,r,i)},stopListening:function(t,e,n,i){var r,s;if(i=i||this,!t&&!e&&!n){for(var r in this._listening)s=this._listening[r],s.stop(e,n,i),Object.keys(this._listening[r]).length||delete this._listening[r];return this}if(!(t instanceof d))throw"First argument was not a valid Dispatcher object";return r=t._id,s=this._listening[r],s.stop(e,n,i),Object.keys(this._listening[r]).length||delete this._listening[r],this}},v=n.Listener=o.extend(g);n.register("whale.Listener",n.Dispatcher);n.Events=n.Dispatcher.extend(g);n.register("whale.Events",n.Events);var y=n.Dispatcher.extend({idAttribute:"id",attrs:{},urlRoot:"",construct:function(t){t&&this.set(t)},url:function(){var t=this.collection?this.urlRoot||this.collection.urlRoot:this.urlRoot;if(!t)throw"Model does not have a urlRoot or is part of a collection with a urlRoot.";return this.isNew()?t:t.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},toJSON:function(){return n.clone(this.attrs)},isNew:function(){return!this.has(this.idAttribute)},get:function(t){return this.attrs[t]},has:function(t){return null!=this.get(t)},fetch:function(){var t=this;this.trigger("request"),this.trigger("fetch");var e=n.Ajax.get({url:this.url(),parse:!0});return e.done(function(e){t.set(t.parse(e)),t.trigger("fetched"),t.trigger("sync")}),e},save:function(t,e){var i,r,s=this;this.trigger("request"),this.trigger("save"),"object"==typeof t?i=t:(i={})[t]=e,null==t&&(i=this.attrs),r=this.isNew()?"POST":"PUT";var o=n.Ajax.request({method:r,data:i,url:this.url(),parse:!0});return o.done(function(t){t=s.parse(t),t&&(this.set(t),s.trigger("saved"),s.trigger("sync"))}),o},parse:function(t){return t},set:function(t,e){var n,i={};if(null==t)return this;"object"==typeof t?i=t:(i={})[t]=e,this.idAttribute in i&&(this.id=i[this.idAttribute]);for(n in i)i.hasOwnProperty(n)&&(this.attrs[n]=i[n]);return this},unset:function(t){return delete this.attrs[t],this}});n.Model=function(t,e,n){n=n||{};var i=f(e,y.extend(n));return null!=t?l(t,i):i};var _=n.Dispatcher.extend({length:0,models:{},_byId:{},model:y,construct:function(t,e){e&&this.set(e)},reset:function(){this.length=0,this.models={},this._byId={}},parse:function(t){return t},set:function(t){return t=Array.isArray(t)?t:[t],console.log(t),this}});n.Collection=function(t,e,n){n=n||{};var i=f(e,_.extend(n));return null!=t?l(t,i):i},n.View=function(t,e,n){n=n||{};var i=f(e,d.extend(n));return null!=t?l(t,i):i},n.Controller=function(t,e,n){n=n||{};var i=f(e,v.extend(n));return null!=t?l(t,i):i},n.Promise=n.register("whale.Promise",n.Class.extend({initialize:function(){this._response=null,this._onDone=[],this._onFail=[],this._onAlways=[],this.pending=!0,this.fulfilled=!1,this.rejected=!1,this.settled=!1},construct:function(t){this._ctx=t||this},resolve:function(){if(this.pending){this._response=arguments,this.fulfilled=!0,this.settled=!0,this.pending=!1;for(var t=0;t<this._onDone.length;t++)this._onDone[t][0].apply(this._onDone[t][1],arguments);for(var t=0;t<this._onAlways.length;t++){var e=Array.prototype.slice.call(arguments);e.unshift(!0),this._onAlways[t][0].apply(this._onAlways[t][1],e)}}return this},reject:function(){if(this.pending){this._response=arguments,this.rejected=!0,this.settled=!0,this.pending=!1;for(var t=0;t<this._onFail.length;t++)this._onFail[t][0].apply(this._onFail[t][1],arguments);for(var t=0;t<this._onAlways.length;t++){var e=Array.prototype.slice.call(arguments);e.unshift(!1),this._onAlways[t][0].apply(this._onAlways[t][1],e)}}return this},done:function(t,e){var n=e||this._ctx;return this._onDone.push([t,n]),this.fulfilled&&t.apply(n,this._response),this},fail:function(t,e){var n=e||this._ctx;return this._onFail.push([t,n]),this.rejected&&t.apply(n,this._response),this},always:function(t,e){var n=e||this._ctx;return this._onAlways.push([t,n]),this.settled&&t.apply(n,this.fulfilled,this._response),this}})),n.Node=n.register("whale.Node",n.Class.extend({splice:Array.prototype.splice,init:function(){this.length=0},construct:function(t){if(t instanceof NodeList||Array.isArray(t))this.elem=t;else if(t&&t.nodeType)this.elem=[t];else if("string"==typeof t){this.elem=[];var e=document.createElement("div");e.innerHTML=t;for(var n=e.childNodes.length-1;n>=0;n--)this.elem[n]=e.childNodes[n]}else this.elem=[]},on:function(t,e,n){var i=this;return n=n||this,this.each(function(r){r.addEventListener(t,function(){e.call(n,i)})})},off:function(t,e){return this.each(function(n){n.removeEventListener(t,e)})},remove:function(){return this.each(function(t){t.parentNode.removeChild(t)})},addClass:function(t){return this.each(function(e){e.className+=" "+t})},hide:function(){return this.each(function(t){t.style.display="none"})},show:function(){return this.each(function(t){t.style.display="block"})},each:function(t){for(var e=0;e<this.elem.length;e++)t(this.elem[e]);return this},outer:function(){return this.elem[0].outerHTML},html:function(t){return t||""===t?this.each(t instanceof this.constructor?function(e){e.innerHTML="",t.each(function(t){e.appendChild(t)})}:function(e){e.innerHTML=t}):this.elem[0].innerHTML},append:function(t){return this.each(t instanceof this.constructor?function(e){t.each(function(t){e.appendChild(t)})}:function(e){e.insertAdjacentHTML("beforeend",t)})},prepend:function(t){return this.each(t instanceof this.constructor?function(e){t.each(function(t){e.insertBefore(t,e.firstChild)})}:function(e){e.insertAdjacentHTML("afterbegin",t)})},before:function(t){return this.each(t instanceof this.constructor?function(e){t.each(function(t){e.parentNode.insertBefore(t,e)})}:function(e){e.insertAdjacentHTML("beforebegin",t)})},after:function(t){var e=this;return this.each(t instanceof e.constructor?function(e){t.each(function(t){e.parentNode.insertBefore(t,e.nextSibling)})}:function(e){e.insertAdjacentHTML("afterend",t)})},find:function(t){var e=[];return this.each(function(n){for(var i=n.querySelectorAll(t),r=i.length-1;r>=0;r--)e[r]=i[r]}),new this.constructor(e)},val:function(t){return"undefined"==typeof t?this.elem[0].value:this.each(function(e){e.value=t})},attr:function(t,e){return"undefined"==typeof e?this.elem[0].getAttribute(t):void this.each(function(n){n.setAttribute(t,e)})},hasAttr:function(t){return this.elem[0].hasAttribute(t)},removeAttr:function(t){return this.each(function(e){e.removeAttribute(t)})},data:function(t,e){return this.attr("data-"+t,e)}})),n.Dom=n.Service("whale.Dom",["whale.Node"],{_matches:{"#":"getElementById",".":"getElementsByClassName","@":"getElementsByName","=":"getElementsByTagName"},construct:function(t){this.Node=t},find:function(t){return new n.Node(document.querySelectorAll(t))}}),n.Ajax=n.Service("whale.Ajax",["whale.Promise"],{construct:function(t){this.Prom=t,this.req=!1},_xhr:function(){return new XMLHttpRequest},encode:function(t){if(!t)return"";var e,n;if(e=[],n=function(t,n){n=r(n)?n():null==n?"":n,e[e.length]=encodeURIComponent(t)+"="+encodeURIComponent(n)},Array.isArray(t)||"object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&n(i,t[i]);else n(t);return e.join("&").replace(/%20/g,"+")},request:function(t){var e,n,i,r,s;if("string"==typeof t&&(t={url:t}),!t.url)throw"a url parameter must be specified";if(s=t.url,i=(t.type||t.method||"GET").toUpperCase(),r=this.encode(t.body||t.data||""),parse=t.parse||!1,headers=t.headers||{},content=t.content||"application/x-www-form-urlencoded; charset=UTF-8",e=new this.Prom,n=this._xhr(),n.onreadystatechange=function(){if(4==n.readyState){var t=n.status;if(!t||(200>t||t>=300)&&304!==t)if(parse)try{e.reject(JSON.parse(n.responseText),n)}catch(i){e.reject("Ajax request returned with error status: "+n.status,n)}else e.reject(n.responseText,n);else if(parse)try{e.resolve(JSON.parse(n.responseText),n)}catch(i){e.reject("responseText is not valid JSON",n)}else e.resolve(n.responseText,n)}},n){"GET"==i&&r&&(s+="?"+r,r=null),n.open(i,s),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),"POST"==i&&n.setRequestHeader("Content-Type",content);for(var o in headers)headers.hasOwnProperty(o)&&n.setRequestHeader(o,headers[o]);n.send(r)}else e.reject("window does not support XMLHttpRequest");return e},get:function(t){return this.request(t)},post:function(t){if("string"==typeof t){var e=t;t={type:"POST",url:e}}else t.type="POST";return this.request(t)},put:function(t){if("string"==typeof t){var e=t;t={type:"PUT",url:e}}else t.type="PUT";return this.request(t)},"delete":function(t){if("string"==typeof t){var e=t;t={type:"DELETE",url:e}}else t.type="DELETE";return this.request(t)}}),n.util={};var m={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;"},w={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},A=/\{\{-(.+?)\}\}|\{\{=(.+?)\}\}|\{\{(.+?)\}\}|$/g,x=/\\|'|\r|\n|\u2028|\u2029/g,j=function(t){return"\\"+w[t]};n.util.escape=function(t){return String(t).replace(/[&<>"'\/]/g,function(t){return m[t]})},n.util.template=function(t){var e=0,i="__p+='";t.replace(A,function(n,r,s,o,u){return i+=t.slice(e,u).replace(x,j),e=u+n.length,r?i+="'+\n((__t=("+r+"))==null?'':whale.util.escape(__t))+\n'":s?i+="'+\n((__t=("+s+"))==null?'':__t)+\n'":o&&(i+="';\n"+o+"\n__p+='"),n}),i+="';\n",i="with(obj||{}){\n"+i+"}\n",i="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+i+"return __p;\n";var r=new Function("obj","whale",i),s=function(t){return r.call(this,t,n)};return s.source="function(obj){\n"+i+"}",s}}.call(this);